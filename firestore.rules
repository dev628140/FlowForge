rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /tasks/{taskId} {
      // Allow a user to get a single task if their email is in the memberEmails list.
      allow get: if request.auth != null && request.auth.token.email in resource.data.memberEmails;

      // Allow a user to query for tasks only if they are filtering by their own email.
      allow list: if request.auth != null && request.query.where.get("memberEmails") != null && request.auth.token.email in request.query.where.get("memberEmails").value();

      // Allow a user to update a task if they are a member.
      allow update: if request.auth != null && request.auth.token.email in resource.data.memberEmails;
      
      // A user can create a task if they are logged in and the userId matches.
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // Only the original owner can delete a task.
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
  }
}
